version: 2.1

jobs:
  Android-Library-Build:
    docker:
      - image: circleci/android:api-29

    environment:
      # Configure the JVM and Gradle to avoid OOM errors
      _JAVA_OPTIONS: "-Xmx3g"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"

    working_directory: ~/repo

    steps:
      - checkout
      - run:
          name: Assemble Harmony Library
          command: ./gradlew :library:assembleRelease

  Android-Library-Upload:
    docker:
      - image: circleci/android:api-29

    environment:
      # Configure the JVM and Gradle to avoid OOM errors
      _JAVA_OPTIONS: "-Xmx3g"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"

    working_directory: ~/repo

    steps:
      - checkout
      - run:
          name: Upload Harmony Library
          command: ./gradlew :library:bintrayUpload

workflows:
  version: 2
  Upload:
    jobs:
      - Android-Library-Build
      - Upload-Approval:
          type: approval
          requires:
            - Android-Library-Build
      - Android-Library-Upload:
          requires:
            - Upload-Approval
          filters:
            branches:
              only: master

